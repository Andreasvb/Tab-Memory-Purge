<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Tab Memory Purge Options</title>
</head>
    <style type="text/css">
        div {
            margin-top: 30px;
        }
        ul {
            list-style-type: none;
        }
    </style>
<body>

<h2><span class="extNameText"></span>&nbsp;<span class="optionText"></span></h2>

<div class="setTimerTitleText"></div>
<hr>
<ul>
    <li><input type="number" name="timer" style="width: 75px;">&nbsp;<span class="minuteText"></span></li>
</ul>

<hr>

<div style="margin-top: 15px;"><span class="exclude_urlText"></span></div>
<textarea name="exclude_url" rows="5" cols="40"></textarea>

<script type="text/javascript" src="js/default.js"></script>
<script type="text/javascript">
    function Run() {
        var locale_i18n = [
            'extName', 'option', 'default', 'minute',
            'setTimerTitle',
            'exclude_url', 
        ];

        // テキストの設定
        for (var i = 0; i < locale_i18n.length; i++) {
            var el      = document.getElementsByClassName(locale_i18n[i] + 'Text');
            var message = chrome.i18n.getMessage(locale_i18n[i]);
            for (var j = 0; j < el.length; j++) {
                var string      = el[j].innerHTML;
                var index       = string.lastIndexOf('</');
                el[j].innerHTML = string.substring(0, index) + message
                                        + string.substring(index);
            }
        }

        var storage = {
            'timer'       : localStorage['timer'],
            'exclude_url' : localStorage['exclude_url'],
            };

        // 除外するドメイン入力欄
        var textarea = document.getElementsByTagName('textarea');
        for (var i = 0; i < textarea.length; i++) {
            var name = textarea[i].name;
            var option = storage[name];
            if (option === undefined) {
                switch (name) {
                    case 'exclude_url':
                        option = default_exclude_url;
                        break;
                    default:
                        option = "";
                        break;
                }
                storage[name]      = option;
                localStorage[name] = option;
            }
            textarea[i].value = option;

            textarea[i].onchange = function() {
                localStorage[ this.name ] = this.value;

                chrome.extension.sendRequest({ event : 'init'});
            }
        }

        var input = document.getElementsByTagName('input');
        for (var i = 0; i < input.length; i++) {
            // データ読み込み
            var name = input[i].name;
            var option = storage[name];
            if (input[i].type == 'number') {
                if (option === undefined) {
                    switch (name) {
                        case 'timer':
                            option = default_timer;
                            break;
                        default:
                            option = 0;
                            break;
                    }
                    storage[name]      = option;
                    localStorage[name] = option;
                } 

                input[i].value = option;
            } else if (input[i].type == 'radio') {
                if (option === undefined) {
                    switch (name) {
                        default:
                            option = 'off';
                            break;
                    }

                    storage[name]      = option;
                    localStorage[name] = option;
                } 

                if (input[i].value == option) {
                    input[i].checked = true;
                }
            } else if (input[i].type == 'checkbox') {
                if (option === undefined) {
                    switch (name) {
                        default:
                            option = 'false';
                            break;
                    }
                    storage[name]      = option;
                    localStorage[name] = option;
                }

                if (option == 'true') {
                    input[i].checked = true;
                } else {
                    input[i].checked = false;
                }
            }

            // データ保存
            input[i].onchange = function() {
                switch (this.type) {
                    case 'radio':
                    case 'number':
                        localStorage[this.name] = this.value;
                        break;
                    case 'checkbox':
                        localStorage[this.name] = this.checked;
                        break;
                    default:
                        throw new Error('データの保存に失敗しました。');
                        break;
                }

                chrome.extension.sendRequest({ event : 'init'});
            }
        };
    }

    window.addEventListener('DOMContentLoaded', Run, false);
</script>
</body>
</html>
